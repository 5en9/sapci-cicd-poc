# This workflow promotes iFlows using a matrix strategy
name: Promote iFlows

on:
  push:
    branches:
      - main
    paths:
      # Trigger on changes in any iFlow directory
      - 'iflows/**'
  workflow_dispatch: # Allows manual runs
    inputs:
      iflow_id:
        description: 'Comma-separated list of iFlow IDs to deploy, or "all" to deploy all iFlows.'
        required: true
        type: string
      tenants:
        description: 'Comma-separated list of tenants to deploy to (e.g., A,B,C). If not provided, will use config/deployment.yml.'
        required: false
        type: string

jobs:
  determine_changes:
    name: ðŸ”Ž Determine Changed iFlows and Tenants
    runs-on: ubuntu-latest
    outputs:
      iflows: ${{ steps.get_changes.outputs.iflows }}
      tenants: ${{ steps.get_config.outputs.tenants }}
      environments: ${{ steps.get_config.outputs.environments }}
      test_environments: ${{ steps.get_config.outputs.test_environments }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch all history for git diff
          fetch-depth: 0

      - name: Set up yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Identify changed iFlows
        id: get_changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then # Manual trigger logic
            IFLOW_ID_INPUT="${{ github.event.inputs.iflow_id }}"
            if [ "$IFLOW_ID_INPUT" == "all" ]; then
              echo "Manual dispatch to deploy all iFlows."
              # List all directories under iflows/, get their base name, and format as JSON
              CHANGED_IFLOWS=$(ls -d iflows/*/ | xargs -n 1 basename | jq -R . | jq -sc .)
            else
              echo "Manual dispatch for specific iFlow(s): $IFLOW_ID_INPUT"
              # Convert comma-separated string to a JSON array, removing whitespace
              CHANGED_IFLOWS=$(echo "$IFLOW_ID_INPUT" | sed 's/ //g' | tr ',' '\n' | jq -R . | jq -sc .)
            fi
          else
            echo "Push event detected, determining changed iFlows."
            # Get changed files between this and the previous commit, extract the iFlow directory, sort unique, and format as JSON
            CHANGED_IFLOWS=$(git diff --name-only HEAD~1 HEAD | grep -oP 'iflows/\K[^/]+' | sort -u | jq -R . | jq -sc .)
          fi
          echo "Detected iFlows for deployment: $CHANGED_IFLOWS"
          echo "iflows=$CHANGED_IFLOWS" >> $GITHUB_OUTPUT

      - name: Determine tenants and environments for deployment
        id: get_config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tenants }}" ]; then
            TENANTS_INPUT="${{ github.event.inputs.tenants }}"
            echo "Using tenants from workflow dispatch: $TENANTS_INPUT"
            TENANTS_JSON=$(echo "$TENANTS_INPUT" | sed 's/ //g' | tr ',' '\n' | jq -R . | jq -sc . | tr '[:lower:]' '[:upper:]')
          elif [ -f "config/deployment.yml" ]; then
            echo "Using tenants from config/deployment.yml"
            TENANTS_JSON=$(yq -o=json '.tenants' config/deployment.yml | jq -c '.' | tr '[:lower:]' '[:upper:]')
          else
            echo "No tenant configuration found, using default tenant: A"
            TENANTS_JSON='["A"]'
          fi
          echo "Tenants for deployment (JSON): $TENANTS_JSON"
          echo "tenants=$TENANTS_JSON" >> $GITHUB_OUTPUT

          if [ -f "config/deployment.yml" ]; then
            echo "Using environments from config/deployment.yml"
            ENV_JSON=$(yq -o=json '.environments' config/deployment.yml | jq -c '.' | tr '[:lower:]' '[:upper:]')
            TEST_ENV_JSON=$(yq -o=json '.test_environments' config/deployment.yml | jq -c '.' | tr '[:lower:]' '[:upper:]')
          else
            echo "No environment configuration found, using default environments: D, Y"
            ENV_JSON='["D", "Y"]'
            TEST_ENV_JSON='["Y"]'
          fi
          echo "Environments for deployment (JSON): $ENV_JSON"
          echo "environments=$ENV_JSON" >> $GITHUB_OUTPUT
          echo "Test environments (JSON): $TEST_ENV_JSON"
          echo "test_environments=$TEST_ENV_JSON" >> $GITHUB_OUTPUT

  build:
    name: ðŸ“¦ Build ${{ matrix.iflow_id }}
    needs: determine_changes
    if: ${{ needs.determine_changes.outputs.iflows != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Continue with other iFlows even if one fails
      matrix:
        iflow_id: ${{ fromJSON(needs.determine_changes.outputs.iflows) }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Archive iFlow and Configs into an Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iflow-artifact-${{ matrix.iflow_id }} # Unique artifact per iFlow
          path: |
            iflows/${{ matrix.iflow_id }}
            config/
          retention-days: 7

  deploy:
    name: ðŸš€ Deploy ${{ matrix.iflow_id }} to ${{ matrix.env }}-${{ matrix.tenant }}
    needs: [determine_changes, build]
    if: ${{ needs.determine_changes.outputs.iflows != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        iflow_id: ${{ fromJSON(needs.determine_changes.outputs.iflows) }}
        tenant: ${{ fromJSON(needs.determine_changes.outputs.tenants) }}
        env: ${{ fromJSON(needs.determine_changes.outputs.environments) }}
    
    environment: ${{ matrix.env }}

    env:
      SECRETS_CONTEXT: ${{ toJSON(secrets) }}

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
            name: iflow-artifact-${{ matrix.iflow_id }}

      - name: Download and Setup Piper
        run: |
          curl -L https://github.com/SAP/jenkins-library/releases/latest/download/piper -o piper
          chmod +x piper
          echo "$(pwd)" >> $GITHUB_PATH

      - name: Set API Key
        id: set_api_key
        run: |
          SECRET_NAME="CI_APISERVICEKEY_${{ matrix.tenant }}"
          API_KEY=$(echo "$SECRETS_CONTEXT" | jq -r ."$SECRET_NAME")
          if [ -z "$API_KEY" ] || [ "$API_KEY" == "null" ]; then
            echo "Error: Secret $SECRET_NAME not found for tenant ${{ matrix.tenant }}."
            exit 1
          fi
          echo "::add-mask::$API_KEY"
          echo "API_KEY=$API_KEY" >> $GITHUB_ENV

      - name: Create Zip Archive
        run: |
          cd iflows/${{ matrix.iflow_id }}
          zip -r ../../${{ matrix.iflow_id }}.zip .

      - name: Upload iFlow
        id: deploy
        uses: SAP/project-piper-action@main
        with:
          step-name: integrationArtifactUpload
          flags: |
            --apiServiceKey ${{ env.API_KEY }}
            --filePath ${{ matrix.iflow_id }}.zip
            --integrationFlowId ${{ matrix.iflow_id }}
            --integrationFlowName ${{ matrix.iflow_id }}
            --verbose true

      - name: Update Configuration and Deploy
        env:
          API_KEY: ${{ env.API_KEY }}
        run: |
          # Define file paths
          PROPDEF_FILE="iflows/${{ matrix.iflow_id }}/src/main/resources/parameters.propdef"
          GLOBAL_CONFIG_FILE="config/parameters-${{ matrix.env }}.prop"
          IFLOW_CONFIG_FILE="iflows/${{ matrix.iflow_id }}/src/main/resources/parameters-${{ matrix.env }}.prop"

          # Check if the definition file exists. If not, there are no parameters to configure.
          if [ ! -f "$PROPDEF_FILE" ]; then
            echo "Parameter definition file not found: $PROPDEF_FILE. Skipping configuration."
          else
            echo "Reading parameter definitions from $PROPDEF_FILE"
            
            while IFS= read -r PARAM_NAME || [[ -n "$PARAM_NAME" ]]; do
                echo "Processing parameter: '$PARAM_NAME'"
                PARAM_VALUE=""

                # 1. Check for iFlow-specific override
                if [ -f "$IFLOW_CONFIG_FILE" ]; then
                  VALUE_LINE=$(grep "^${PARAM_NAME}=" "$IFLOW_CONFIG_FILE" || true)
                  if [ -n "$VALUE_LINE" ]; then
                    PARAM_VALUE=$(echo "$VALUE_LINE" | cut -d'=' -f2-)
                    echo "  Found iFlow-specific value."
                  fi
                fi
                # 2. If not found, check for global value
                if [ -z "$PARAM_VALUE" ] && [ -f "$GLOBAL_CONFIG_FILE" ]; then
                  VALUE_LINE=$(grep "^${PARAM_NAME}=" "$GLOBAL_CONFIG_FILE" || true)
                  if [ -n "$VALUE_LINE" ]; then
                    PARAM_VALUE=$(echo "$VALUE_LINE" | cut -d'=' -f2-)
                    echo "  Found global value."
                  fi
                fi
                # 3. If a value was found, update the configuration
                if [ -n "$PARAM_VALUE" ]; then
                  echo "  Attempting to update iFlow with Key: '$PARAM_NAME'"
                  output=$(piper integrationArtifactUpdateConfiguration \
                      --apiServiceKey "$API_KEY" \
                      --integrationFlowId "${{ matrix.iflow_id }}" \
                      --integrationFlowVersion "active" \
                      --parameterKey "$PARAM_NAME" \
                      --parameterValue "$PARAM_VALUE" \
                      --verbose true 2>&1)
                  exit_code=$?

                  echo "$output"

                  if [ $exit_code -ne 0 ]; then
                    if echo "$output" | grep -q -E "does not exist|not found for Integration Flow"; then
                      echo "Warning: Parameter '$PARAM_NAME' not found on iFlow. This is expected for package-level parameters. Skipping."
                    else
                      echo "Error: A critical error occurred during parameter update. Failing the step."
                      exit 1
                    fi
                  fi
                else
                  echo "  No value found for '$PARAM_NAME' in property files. Skipping."
                fi
            done < <(grep -oP '<name>\K[^<]+' "$PROPDEF_FILE")
          fi
          
          echo "Configuration updated. Now deploying the iFlow..."
          piper integrationArtifactDeploy \
            --apiServiceKey "$API_KEY" \
            --integrationFlowId "${{ matrix.iflow_id }}" \
            --verbose true

      - name: Automated Testing
        if: contains(fromJSON(needs.determine_changes.outputs.test_environments), matrix.env)
        run: |
          echo "Running automated tests for environment ${{ matrix.env }}..."
          # Add your testing commands here